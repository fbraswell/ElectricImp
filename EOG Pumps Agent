const informa_level_sensor = "2348143643fc42ee";
const wellmark_level_sensor = "2342173643fc42ee";
const wellmark_685e = "237c523643fc42ee";
const wellmark_chem_pump = "231a80eb6e4936ee";
const wellmark_high_level_alarm = "232ace4dead3dbee";
const WM_2366_high_level_alarm = "23669d4dead3dbee";
const WM_2307_high_level_alarm = "230789eb6e4936ee"; // chem
const WM_2313_high_level_alarm = "23139deb6e4936ee";
const WM_2325_high_level_alarm = "233252b236a7c9ee";
const WM_233c_high_level_alarm = "233c66eb6e4936ee"; // chem
const WM_2356_high_level_alarm = "23560c4cead3dbee";
const WM_236f_high_level_alarm = "236f544cead3dbee";
const WM_2370_high_level_alarm = "23703eeb6e4936ee";
const WM_2371_high_level_alarm = "23712eeb6e4936ee";
const WM_2348_high_level_alarm = "2348143643fc42ee";
const WM_2342_high_level_alarm = "2342173643fc42ee";
const WM_237c_high_level_alarm = "237c523643fc42ee";

imp_table <- 
    {
        // insert new imps below
        // --This agent is for Chemical Pumps only!
        InformaChemPump1 = {   impid = "230789eb6e4936ee", feed = 627874217, apikey = "w1buKrbzAknYTWiVGUsIsYY4C0asD1iF5KErllKbXR3VpEMi"  
                           , sample_interval = 5 },
        // DC Modbus
         InformaChemPump2 = {   impid = "234f47eb6e4936ee", feed = 1348944517, apikey = "8aavsrXlDAfIevDIaH9KRNQndh2gcFR0ubABd47dHod0jiqX"  
                           , sample_interval = 5 },
        // AC Modbus
         InformaChemPump3 = {   impid = "23669d4dead3dbee", feed = 1325563619, apikey = "yvIsehmvB1EGt4rAQrKObbDTFdtNIgExhvkXoi5h75R5xRZt"  
                           , sample_interval = 5 },
//        InformaChemPump1 = {   impid = "233c66eb6e4936ee", feed = 627874217, apikey = "w1buKrbzAknYTWiVGUsIsYY4C0asD1iF5KErllKbXR3VpEMi" 
//                                 , sample_interval = 5, voltage_enable = 0  },
        InformaBrineTank1 = {   impid = "2307xx", feed = 1432343757, apikey = "9ehXeWj4AFJ5TD2rKiRInZ664Xv6qiuiGtxciWGLseWIxJ3e"  },
        InformaCrudeTank1 = {   impid = "2307xx", feed = 2033339257, apikey = "fIiRLSNzPa6k4aLm6MahSd3G9NTqwwEsL3UWUql2EGrHKp9o"  },
        InformaChemTank1 = {   impid = "2307xx", feed = 2105788416, apikey = "CbJjQsmbIKKhmvfwNXTXm2geO9lmsROQX3yB1YQKo37F6H1o"  },
        
        InformaBrineTank2 = {   impid = "2307xx", feed = 670154089, apikey = "j8V2lVnlChthy46Ocv4epRgONhM9Iupu5cltAcfy9KzCk5es",
                                sample_interval = 30, voltage_enable = 0  },
          InformaCrudeTank2 = {   impid = "2307xx", feed = 865841957, apikey = "kql4mJhhNrGWqAimEQOTJkzOSqwXzN2k9YmIFXbBY5n82ZEn", 
                                  sample_interval = 20, voltage_enable = 0  },
          InformaChemTank2 = {   impid = "23484feb6e4936ee", feed = 1995311635, apikey = "EY8ON0sBYDAVmocxjYIrWAxUggZzxcNrrO1R9NsvXyxthfu1"  }, 

        DevonChemPump1 = {   impid = "233a1aeb6e4936ee", feed = 2008148184, apikey = "qEIbXubi2bD6DjQBNkyWEGv5fBq2kbCijIxvS3TyZ30dHhlT"  },
        DevonChemPump2 = {   impid = "23560c4cead3dbee", feed = 802343163, apikey = "m1tKlcAgqxPY180HDQe4f82IJWA9LIvFI6dcyuhCvPePYUmb"  },
        DevonChemTank1 = {   impid = "2307xx", feed = 547315046, apikey = "lNbRVoON2zpFe9LmMrBrS86Fni0Zm1W6h6x2ayumNhDYQUav"  },
        DevonChemTank2 = {   impid = "2307xx", feed = 277137983, apikey = "OjD9OsvgG4NpsBCtoLYt67FLMBmzOnLbXTQFHoFlHu3l0R21"  },
        DevonBrineTank1 = {   impid = "2307xx", feed = 1761598148, apikey = "vlylRGnqifM3rpjcmdZRNk6ZC62Akl2j0KTAq7SCG4CQSR3G"  },
        DevonBrineTank2 = {   impid = "2307xx", feed = 33889245, apikey = "z7ltHrzMtiEfbYJI6hrAPEWQHVzh7VXPMwfnZH0eUizGA2vb"  },

        WellMarkDemoChemPump = {   impid = "2307xx", feed = 1266829895, apikey = "MI5vJbWAsfChUMfJc5bzRmAHpx0vcRWesnzuzaR3Wq6SuU0c"  },
        WellMarkDemoLevel = {   impid = "2307xx", feed = 2012325919, apikey = "suAoU5udCBqBOD9BmM3RGTuCyVf6STHHHmOcssfEjPhL1tPV"  },
        WellMarkDemoSwitch = {   impid = "2307xx", feed = 848109198, apikey = "CLT3ehpzXv1RAwYQDsSzE8HmXQLcjspRBPcc3YQDgbwSKahT"  },

         EOGChemPump1 = {   impid = "234f47eb6e4936ee", feed = 2099714343, apikey = "mRJx9jKahQDHdIVDjd1GaISZOM4pc3XlV5QBPFUgQk7avbjE"  
                           , sample_interval = 1800},
        EOGChemTank1 = {   impid = "xx237c523643fc42ee", feed = 2099714343, apikey = "mRJx9jKahQDHdIVDjd1GaISZOM4pc3XlV5QBPFUgQk7avbjE"  
                           , sample_interval = 1800},

        xx230789eb6e4936ee =
        {   impid = "x230789eb6e4936ee",
            feed = 467812498,
            apikey = "XEiiq8NpLgyLWXMICo1CsQRQa2Fd5vJ9omtmvQhSPNiyHKlX"
        },
        
        x233c66eb6e4936ee =
        {   impid = "xx233c66eb6e4936ee",
            feed = 2116002450,
            apikey = "RhNcfs5gkF93Bzw5RGywafbwpRHYZnryrSwVndoxlibi3vak"
        },
        
        x2342173643fc42ee =
        {   impid = "2342173643fc42ee", // dummy id
            feed = 467812498,
            apikey = "XEiiq8NpLgyLWXMICo1CsQRQa2Fd5vJ9omtmvQhSPNiyHKlX"
        }
        
    }; // end imp_table

// bssid: 881fa13a9c3c     SOM Network3                Home Network
// bssid: 0015ff7bf869     Verizon-MiFi5510L-F869      Verizon Jetpack 
// bssid: 0015ff6109ef     SA2100-WSXW                 Novatel Modem

// WellMark chem pump Xively feed
// Data feed: 467812498
// "X-Api-Key": "XEiiq8NpLgyLWXMICo1CsQRQa2Fd5vJ9omtmvQhSPNiyHKlX" = 230789eb6e4936ee

// WellMark flow test Xively feed
// Data feed: 2116002450
// "X-Api-Key": "RhNcfs5gkF93Bzw5RGywafbwpRHYZnryrSwVndoxlibi3vak" = 233c66eb6e4936ee

agent_myimpid <- 0; // Imp ID
agent_myapikey <- 0; // api key
agent_myfeed <- 0;  // feed id

// This function gets the ImpID from the associated Imp
// and then connects it to a specific Xively data feed
device.on("impid", function(impid)
{
//    server.log("Agent received ImpID: "+impid.ImpID);
    // need to put an x infront of the imp id
local    agent_myimpid = format("%s",impid.ImpID);
//    agent_myimpid = impid.ImpID;
    server.log("Agent received ImpID: "+agent_myimpid);
    foreach ( key in imp_table)
    {
//        server.log("-value of key: "+key+"value of feed: "+key.feed);
        if (key.impid == agent_myimpid)
        {
            agent_myapikey = key.apikey;
            agent_myfeed = key.feed;
        }
    }
    
    server.log("Agent api key: "+agent_myapikey);

});

function fetchNewSetpoint() {
/*
http.get("https://wellmark.webscript.io/commands").sendasync(function(response) {
        server.log("Found new set point: " + response.body);
        device.send("newsetpoint", response.body.tofloat());
    });
*/    
//    assetFeedID = request.query.feedID
//    assetAPIKey = request.query.apiKey
//    xivelyChannelName = request.query.xivelyChannelName
/*
    local tempstr = http.get("https://wellmark-user.webscript.io/get-value",
    {
        feedID=agent_myfeed,
        apiKey=agent_myapikey,
        xivelyChannelName="Set_QuartsPerDay"
    });
    
//    server.log("++http get str: "+tempstr);

    http.get("https://wellmark-user.webscript.io/get-value?feedID=627874217&apiKey=w1buKrbzAknYTWiVGUsIsYY4C0asD1iF5KErllKbXR3VpEMi&xivelyChannelName=Set_QuartsPerDay").sendasync(function(response)
    {
        server.log(format("--x response code: %d set point: ", response.statuscode)+ response.body);
    });
*/
    local getValueURL = format(
        "%s%d%s%s%s",
        "https://wellmark-user.webscript.io/get-value?feedID=",
        agent_myfeed,
        "&apiKey=",
        agent_myapikey,
        "&xivelyChannelName=Set_QuartsPerDay");
    server.log(format("--Get-Value URL: %s", getValueURL));
    local getValueRequest = http.get(getValueURL);
    getValueRequest.sendasync(function(response)
    {
        server.log(format("--The response code: %d and set point: ", response.statuscode)+ response.body);
        device.send("newsetpoint", response.body.tofloat());
    });

/*    
    http.get("https://wellmark-user.webscript.io/get-value",
    {
        feedID=agent_myfeed,
        apiKey=agent_myapikey,
        xivelyChannelName="Set_QuartsPerDay"
    }).sendasync(function(response)
    {
        server.log(format("--response code: %d set point: ", response.statuscode)+ response.body);
    });
*/    
}

device.on("csv", function(csv) {
    
    if (csv.len() > 0){
        server.log("Sending Xively this data: " + csv);    

        http.put(format("%s%d%s","https://api.xively.com/v2/feeds/", agent_myfeed, ".csv"), {
            "X-Api-Key": agent_myapikey,
            "Authorization": "Basic ZmJyYXN3ZWxsOm1lcnJpdHQxODY1"
        }, csv).sendasync(function(response) {
            server.log("xively response: "+response.statuscode);
            fetchNewSetpoint();
        });
    }
    else {
        server.log("Nothing to send to Xively.");    
        fetchNewSetpoint();
    }

});
